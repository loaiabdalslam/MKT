{"version":3,"sources":["../src/neural-network.js"],"names":["NeuralNetwork","iterations","errorThresh","log","logPeriod","learningRate","momentum","callback","callbackPeriod","timeout","Infinity","praxis","beta1","beta2","epsilon","leakyReluAlpha","binaryThresh","hiddenLayers","activation","options","Object","assign","constructor","defaults","trainOpts","updateTrainingOptions","trainDefaults","sizes","outputLayer","biases","weights","outputs","deltas","changes","errors","errorCheckInterval","prototype","hasOwnProperty","runInput","calculateDeltas","inputLookup","inputLookupLength","outputLookup","outputLookupLength","Error","length","layer","size","Array","node","prevSize","setActivation","_setupAdam","_runInputSigmoid","_calculateDeltasSigmoid","_runInputRelu","_calculateDeltasRelu","_runInputLeakyRelu","_calculateDeltasLeakyRelu","_runInputTanh","_calculateDeltasTanh","input","isRunnable","lookup","toArray","output","slice","toObject","sum","k","Math","exp","alpha","tanh","data","push","max","floor","forEach","initialize","p","validateTrainingOptions","setLogMethod","validations","val","keys","reduce","opts","opt","console","i","trainPattern","status","endTime","error","Date","now","calculateTrainingError","trainPatterns","formatData","verifyIsInitialized","prepTraining","trainingTick","Promise","resolve","reject","thawedTrain","Thaw","delay","each","stop","done","tick","trainError","value","logErrorRate","adjustWeights","target","incoming","delta","change","biasChangesLow","biasChangesHigh","changesLow","changesHigh","_adjustWeightsAdam","gradient","changeLow","changeHigh","momentumCorrection","pow","gradientCorrection","sqrt","biasGradient","biasChangeLow","biasChangeHigh","biasMomentumCorrection","biasGradientCorrection","isArray","LookupTable","table","_formatInput","getTypedArrayFn","_formatOutput","result","addKeys","isBinary","misclasses","errorSum","falsePos","falseNeg","truePos","trueNeg","actual","expected","misclass","map","total","precision","recall","accuracy","indexOf","layers","nodes","j","bias","index","getTrainOptsJSON","json","toHash","needsVar","nodeHandle","layerNumber","nodeKey","w","join","toJSON","layersAsMath","key","Function","checkFns","filter","c","buffer","ArrayBuffer","arrayToFloat32Array","v","array","Float32Array"],"mappings":"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","file":"neural-network.js","sourcesContent":["import Thaw from 'thaw.js';\nimport lookup from './lookup';\nimport max from './utilities/max';\nimport mse from './utilities/mse';\nimport randos from './utilities/randos';\nimport range from './utilities/range';\nimport toArray from './utilities/to-array';\nimport zeros from './utilities/zeros';\nimport LookupTable from './utilities/lookup-table';\nimport { arrayToFloat32Array } from './utilities/cast';\n\n/**\n * @param {object} options\n * @constructor\n */\nexport default class NeuralNetwork {\n  static get trainDefaults() {\n    return {\n      iterations: 20000,    // the maximum times to iterate the training data\n      errorThresh: 0.005,   // the acceptable error percentage from training data\n      log: false,           // true to use console.log, when a function is supplied it is used\n      logPeriod: 10,        // iterations between logging out\n      learningRate: 0.3,    // multiply's against the input and the delta then adds to momentum\n      momentum: 0.1,        // multiply's against the specified \"change\" then adds to learning rate for change\n      callback: null,       // a periodic call back that can be triggered while training\n      callbackPeriod: 10,   // the number of iterations through the training data between callback calls\n      timeout: Infinity,    // the max number of milliseconds to train for\n      praxis: null,\n      beta1: 0.9,\n      beta2: 0.999,\n      epsilon: 1e-8,\n    };\n  }\n\n  static get defaults() {\n    return {\n      leakyReluAlpha: 0.01,\n      binaryThresh: 0.5,\n      hiddenLayers: null,     // array of ints for the sizes of the hidden layers in the network\n      activation: 'sigmoid'  // Supported activation types ['sigmoid', 'relu', 'leaky-relu', 'tanh']\n    };\n  }\n\n  constructor(options = {}) {\n    Object.assign(this, this.constructor.defaults, options);\n    this.trainOpts = {};\n    this.updateTrainingOptions(Object.assign({}, this.constructor.trainDefaults, options));\n\n    this.sizes = null;\n    this.outputLayer = null;\n    this.biases = null; // weights for bias nodes\n    this.weights = null;\n    this.outputs = null;\n\n    // state for training\n    this.deltas = null;\n    this.changes = null; // for momentum\n    this.errors = null;\n    this.errorCheckInterval = 1;\n    if (!this.constructor.prototype.hasOwnProperty('runInput')) {\n      this.runInput = null;\n    }\n    if (!this.constructor.prototype.hasOwnProperty('calculateDeltas')) {\n      this.calculateDeltas = null;\n    }\n    this.inputLookup = null;\n    this.inputLookupLength = null;\n    this.outputLookup = null;\n    this.outputLookupLength = null;\n  }\n\n  /**\n   *\n   * Expects this.sizes to have been set\n   */\n  initialize() {\n    if (!this.sizes) throw new Error ('Sizes must be set before initializing');\n\n    this.outputLayer = this.sizes.length - 1;\n    this.biases = []; // weights for bias nodes\n    this.weights = [];\n    this.outputs = [];\n\n    // state for training\n    this.deltas = [];\n    this.changes = []; // for momentum\n    this.errors = [];\n\n    for (let layer = 0; layer <= this.outputLayer; layer++) {\n      let size = this.sizes[layer];\n      this.deltas[layer] = zeros(size);\n      this.errors[layer] = zeros(size);\n      this.outputs[layer] = zeros(size);\n\n      if (layer > 0) {\n        this.biases[layer] = randos(size);\n        this.weights[layer] = new Array(size);\n        this.changes[layer] = new Array(size);\n\n        for (let node = 0; node < size; node++) {\n          let prevSize = this.sizes[layer - 1];\n          this.weights[layer][node] = randos(prevSize);\n          this.changes[layer][node] = zeros(prevSize);\n        }\n      }\n    }\n\n    this.setActivation();\n    if (this.trainOpts.praxis === 'adam') {\n      this._setupAdam();\n    }\n  }\n\n  /**\n   *\n   * @param activation supported inputs: 'sigmoid', 'relu', 'leaky-relu', 'tanh'\n   */\n  setActivation(activation) {\n    this.activation = activation ? activation : this.activation;\n    switch (this.activation) {\n      case 'sigmoid':\n        this.runInput = this.runInput || this._runInputSigmoid;\n        this.calculateDeltas = this.calculateDeltas || this._calculateDeltasSigmoid;\n        break;\n      case 'relu':\n        this.runInput = this.runInput || this._runInputRelu;\n        this.calculateDeltas = this.calculateDeltas || this._calculateDeltasRelu;\n        break;\n      case 'leaky-relu':\n        this.runInput = this.runInput || this._runInputLeakyRelu;\n        this.calculateDeltas = this.calculateDeltas || this._calculateDeltasLeakyRelu;\n        break;\n      case 'tanh':\n        this.runInput = this.runInput || this._runInputTanh;\n        this.calculateDeltas = this.calculateDeltas || this._calculateDeltasTanh;\n        break;\n      default:\n        throw new Error('unknown activation ' + this.activation + ', The activation should be one of [\\'sigmoid\\', \\'relu\\', \\'leaky-relu\\', \\'tanh\\']');\n    }\n  }\n\n  /**\n   *\n   * @returns boolean\n   */\n  get isRunnable(){\n    if(!this.runInput){\n      console.error('Activation function has not been initialized, did you run train()?');\n      return false;\n    }\n\n    const checkFns = [\n      'sizes',\n      'outputLayer',\n      'biases',\n      'weights',\n      'outputs',\n      'deltas',\n      'changes',\n      'errors',\n    ].filter(c => this[c] === null);\n\n    if(checkFns.length > 0){\n      console.error(`Some settings have not been initialized correctly, did you run train()? Found issues with: ${checkFns.join(', ')}`);\n      return false;\n    }\n    return true;\n  }\n\n\n  /**\n   *\n   * @param input\n   * @returns {*}\n   */\n  run(input) {\n    if (!this.isRunnable) return null;\n    if (this.inputLookup) {\n      input = lookup.toArray(this.inputLookup, input, this.inputLookupLength);\n    }\n\n    let output = this.runInput(input).slice(0);\n\n    if (this.outputLookup) {\n      output = lookup.toObject(this.outputLookup, output);\n    }\n    return output;\n  }\n\n  /**\n   * trains via sigmoid\n   * @param input\n   * @returns {*}\n   */\n  _runInputSigmoid(input) {\n    this.outputs[0] = input;  // set output state of input layer\n\n    let output = null;\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let weights = this.weights[layer][node];\n\n        let sum = this.biases[layer][node];\n        for (let k = 0; k < weights.length; k++) {\n          sum += weights[k] * input[k];\n        }\n        //sigmoid\n        this.outputs[layer][node] = 1 / (1 + Math.exp(-sum));\n      }\n      output = input = this.outputs[layer];\n    }\n    return output;\n  }\n\n  _runInputRelu(input) {\n    this.outputs[0] = input;  // set output state of input layer\n\n    let output = null;\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let weights = this.weights[layer][node];\n\n        let sum = this.biases[layer][node];\n        for (let k = 0; k < weights.length; k++) {\n          sum += weights[k] * input[k];\n        }\n        //relu\n        this.outputs[layer][node] = (sum < 0 ? 0 : sum);\n      }\n      output = input = this.outputs[layer];\n    }\n    return output;\n  }\n\n  _runInputLeakyRelu(input) {\n    this.outputs[0] = input;  // set output state of input layer\n    let alpha = this.leakyReluAlpha;\n    let output = null;\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let weights = this.weights[layer][node];\n\n        let sum = this.biases[layer][node];\n        for (let k = 0; k < weights.length; k++) {\n          sum += weights[k] * input[k];\n        }\n        //leaky relu\n        this.outputs[layer][node] = (sum < 0 ? 0 : alpha * sum);\n      }\n      output = input = this.outputs[layer];\n    }\n    return output;\n  }\n\n  _runInputTanh(input) {\n    this.outputs[0] = input;  // set output state of input layer\n\n    let output = null;\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let weights = this.weights[layer][node];\n\n        let sum = this.biases[layer][node];\n        for (let k = 0; k < weights.length; k++) {\n          sum += weights[k] * input[k];\n        }\n        //tanh\n        this.outputs[layer][node] = Math.tanh(sum);\n      }\n      output = input = this.outputs[layer];\n    }\n    return output;\n  }\n\n  /**\n   *\n   * @param data\n   * Verifies network sizes are initialized\n   * If they are not it will initialize them based off the data set.\n   */\n  verifyIsInitialized(data) {\n    if (this.sizes) return;\n\n    this.sizes = [];\n    this.sizes.push(data[0].input.length);\n    if (!this.hiddenLayers) {\n      this.sizes.push(Math.max(3, Math.floor(data[0].input.length / 2)));\n    } else {\n      this.hiddenLayers.forEach(size => {\n        this.sizes.push(size);\n      });\n    }\n    this.sizes.push(data[0].output.length);\n\n    this.initialize();\n  }\n\n  /**\n   *\n   * @param options\n   *    Supports all `trainDefaults` properties\n   *    also supports:\n   *       learningRate: (number),\n   *       momentum: (number),\n   *       activation: 'sigmoid', 'relu', 'leaky-relu', 'tanh'\n   */\n  updateTrainingOptions(options) {\n    const trainDefaults = this.constructor.trainDefaults;\n    for (const p in trainDefaults) {\n      if (!trainDefaults.hasOwnProperty(p)) continue;\n      this.trainOpts[p] = options.hasOwnProperty(p)\n        ? options[p]\n        : trainDefaults[p];\n    }\n    this.validateTrainingOptions(this.trainOpts);\n    this.setLogMethod(options.log || this.trainOpts.log);\n    this.activation = options.activation || this.activation;\n  }\n\n  /**\n   *\n   * @param options\n   */\n  validateTrainingOptions(options) {\n    const validations = {\n      iterations: (val) => { return typeof val === 'number' && val > 0; },\n      errorThresh: (val) => { return typeof val === 'number' && val > 0 && val < 1; },\n      log: (val) => { return typeof val === 'function' || typeof val === 'boolean'; },\n      logPeriod: (val) => { return typeof val === 'number' && val > 0; },\n      learningRate: (val) => { return typeof val === 'number' && val > 0 && val < 1; },\n      momentum: (val) => { return typeof val === 'number' && val > 0 && val < 1; },\n      callback: (val) => { return typeof val === 'function' || val === null },\n      callbackPeriod: (val) => { return typeof val === 'number' && val > 0; },\n      timeout: (val) => { return typeof val === 'number' && val > 0 }\n    };\n    for (const p in validations) {\n      if (!validations.hasOwnProperty(p)) continue;\n      if (!options.hasOwnProperty(p)) continue;\n      if (!validations[p](options[p])) {\n        throw new Error(`[${p}, ${options[p]}] is out of normal training range, your network will probably not train.`);\n      }\n    }\n  }\n\n  /**\n   *\n   *  Gets JSON of trainOpts object\n   *    NOTE: Activation is stored directly on JSON object and not in the training options\n   */\n  getTrainOptsJSON() {\n    return Object.keys(this.constructor.trainDefaults)\n      .reduce((opts, opt) => {\n        if (opt === 'timeout' && this.trainOpts[opt] === Infinity) return opts;\n        if (opt === 'callback') return opts;\n        if (this.trainOpts[opt]) opts[opt] = this.trainOpts[opt];\n        if (opt === 'log') opts.log = typeof opts.log === 'function';\n        return opts;\n      }, {});\n  }\n\n  /**\n   *\n   * @param log\n   * if a method is passed in method is used\n   * if false passed in nothing is logged\n   * @returns error\n   */\n  setLogMethod(log) {\n    if (typeof log === 'function'){\n      this.trainOpts.log = log;\n    } else if (log) {\n      this.trainOpts.log = console.log;\n    } else {\n      this.trainOpts.log = false;\n    }\n  }\n\n  /**\n   *\n   * @param data\n   * @returns {Number} error\n   */\n  calculateTrainingError(data) {\n    let sum = 0;\n    for (let i = 0; i < data.length; ++i) {\n      sum += this.trainPattern(data[i], true);\n    }\n    return sum / data.length;\n  }\n\n  /**\n   * @param data\n   */\n  trainPatterns(data) {\n    for (let i = 0; i < data.length; ++i) {\n      this.trainPattern(data[i]);\n    }\n  }\n\n  /**\n   *\n   * @param {object} data\n   * @param {object} status { iterations: number, error: number }\n   * @param endTime\n   */\n  trainingTick(data, status, endTime) {\n    if (status.iterations >= this.trainOpts.iterations || status.error <= this.trainOpts.errorThresh || Date.now() >= endTime) {\n      return false;\n    }\n\n    status.iterations++;\n\n    if (this.trainOpts.log && (status.iterations % this.trainOpts.logPeriod === 0)) {\n      status.error = this.calculateTrainingError(data);\n      this.trainOpts.log(`iterations: ${status.iterations}, training error: ${status.error}`);\n    } else {\n      if (status.iterations % this.errorCheckInterval === 0) {\n        status.error = this.calculateTrainingError(data);\n      } else {\n        this.trainPatterns(data);\n      }\n    }\n\n    if (this.trainOpts.callback && (status.iterations % this.trainOpts.callbackPeriod === 0)) {\n      this.trainOpts.callback({\n        iterations: status.iterations,\n        error: status.error\n      });\n    }\n    return true;\n  }\n\n  /**\n   *\n   * @param data\n   * @param options\n   * @protected\n   * @return {object} { data, status, endTime }\n   */\n  prepTraining(data, options) {\n    this.updateTrainingOptions(options);\n    data = this.formatData(data);\n    const endTime = Date.now() + this.trainOpts.timeout;\n\n    const status = {\n      error: 1,\n      iterations: 0\n    };\n\n    this.verifyIsInitialized(data);\n\n    return {\n      data,\n      status,\n      endTime\n    };\n  }\n\n  /**\n   *\n   * @param data\n   * @param options\n   * @returns {object} {error: number, iterations: number}\n   */\n  train(data, options = {}) {\n    let status, endTime;\n    ({ data, status, endTime } = this.prepTraining(data, options));\n\n    while (this.trainingTick(data, status, endTime));\n    return status;\n  }\n\n  /**\n   *\n   * @param data\n   * @param options\n   * @returns {Promise}\n   * @resolves {{error: number, iterations: number}}\n   * @rejects {{trainError: string, status: {error: number, iterations: number}}\n   */\n  trainAsync(data, options = {}) {\n    let status, endTime;\n    ({ data, status, endTime } = this.prepTraining(data, options));\n\n    return new Promise((resolve, reject) => {\n      try {\n        const thawedTrain = new Thaw(new Array(this.trainOpts.iterations), {\n          delay: true,\n          each: () => this.trainingTick(data, status, endTime) || thawedTrain.stop(),\n          done: () => resolve(status)\n        });\n        thawedTrain.tick();\n      } catch (trainError) {\n        reject({trainError, status});\n      }\n    });\n  }\n\n  /**\n   *\n   * @param {object} value\n   * @param {boolean} [logErrorRate]\n   */\n  trainPattern(value, logErrorRate) {\n    // forward propagate\n    this.runInput(value.input);\n\n    // back propagate\n    this.calculateDeltas(value.output);\n    this.adjustWeights();\n\n    if  (logErrorRate) {\n      return mse(this.errors[this.outputLayer]);\n    } else {\n      return null;\n    }\n  }\n\n  /**\n   *\n   * @param target\n   */\n  _calculateDeltasSigmoid(target) {\n    for (let layer = this.outputLayer; layer >= 0; layer--) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let output = this.outputs[layer][node];\n\n        let error = 0;\n        if (layer === this.outputLayer) {\n          error = target[node] - output;\n        }\n        else {\n          let deltas = this.deltas[layer + 1];\n          for (let k = 0; k < deltas.length; k++) {\n            error += deltas[k] * this.weights[layer + 1][k][node];\n          }\n        }\n        this.errors[layer][node] = error;\n        this.deltas[layer][node] = error * output * (1 - output);\n      }\n    }\n  }\n\n  /**\n   *\n   * @param target\n   */\n  _calculateDeltasRelu(target) {\n    for (let layer = this.outputLayer; layer >= 0; layer--) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let output = this.outputs[layer][node];\n\n        let error = 0;\n        if (layer === this.outputLayer) {\n          error = target[node] - output;\n        }\n        else {\n          let deltas = this.deltas[layer + 1];\n          for (let k = 0; k < deltas.length; k++) {\n            error += deltas[k] * this.weights[layer + 1][k][node];\n          }\n        }\n        this.errors[layer][node] = error;\n        this.deltas[layer][node] = output > 0 ? error : 0;\n      }\n    }\n  }\n\n  /**\n   *\n   * @param target\n   */\n  _calculateDeltasLeakyRelu(target) {\n    let alpha = this.leakyReluAlpha;\n    for (let layer = this.outputLayer; layer >= 0; layer--) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let output = this.outputs[layer][node];\n\n        let error = 0;\n        if (layer === this.outputLayer) {\n          error = target[node] - output;\n        }\n        else {\n          let deltas = this.deltas[layer + 1];\n          for (let k = 0; k < deltas.length; k++) {\n            error += deltas[k] * this.weights[layer + 1][k][node];\n          }\n        }\n        this.errors[layer][node] = error;\n        this.deltas[layer][node] = output > 0 ? error : alpha * error;\n      }\n    }\n  }\n\n  /**\n   *\n   * @param target\n   */\n  _calculateDeltasTanh(target) {\n    for (let layer = this.outputLayer; layer >= 0; layer--) {\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let output = this.outputs[layer][node];\n\n        let error = 0;\n        if (layer === this.outputLayer) {\n          error = target[node] - output;\n        }\n        else {\n          let deltas = this.deltas[layer + 1];\n          for (let k = 0; k < deltas.length; k++) {\n            error += deltas[k] * this.weights[layer + 1][k][node];\n          }\n        }\n        this.errors[layer][node] = error;\n        this.deltas[layer][node] = (1 - output * output) * error;\n      }\n    }\n  }\n\n  /**\n   *\n   * Changes weights of networks\n   */\n  adjustWeights() {\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      let incoming = this.outputs[layer - 1];\n\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        let delta = this.deltas[layer][node];\n\n        for (let k = 0; k < incoming.length; k++) {\n          let change = this.changes[layer][node][k];\n\n          change = (this.trainOpts.learningRate * delta * incoming[k])\n            + (this.trainOpts.momentum * change);\n\n          this.changes[layer][node][k] = change;\n          this.weights[layer][node][k] += change;\n        }\n        this.biases[layer][node] += this.trainOpts.learningRate * delta;\n      }\n    }\n  }\n\n  _setupAdam() {\n    this.biasChangesLow = [];\n    this.biasChangesHigh = [];\n    this.changesLow = [];\n    this.changesHigh = [];\n    this.iterations = 0;\n\n    for (let layer = 0; layer <= this.outputLayer; layer++) {\n      let size = this.sizes[layer];\n      if (layer > 0) {\n        this.biasChangesLow[layer] = zeros(size);\n        this.biasChangesHigh[layer] = zeros(size);\n        this.changesLow[layer] = new Array(size);\n        this.changesHigh[layer] = new Array(size);\n\n        for (let node = 0; node < size; node++) {\n          let prevSize = this.sizes[layer - 1];\n          this.changesLow[layer][node] = zeros(prevSize);\n          this.changesHigh[layer][node] = zeros(prevSize);\n        }\n      }\n    }\n\n    this.adjustWeights = this._adjustWeightsAdam;\n  }\n\n  _adjustWeightsAdam() {\n    const trainOpts = this.trainOpts;\n    this.iterations++;\n\n    for (let layer = 1; layer <= this.outputLayer; layer++) {\n      const incoming = this.outputs[layer - 1];\n\n      for (let node = 0; node < this.sizes[layer]; node++) {\n        const delta = this.deltas[layer][node];\n\n        for (let k = 0; k < incoming.length; k++) {\n          const gradient = delta * incoming[k];\n          const changeLow = this.changesLow[layer][node][k] * trainOpts.beta1 + (1 - trainOpts.beta1) * gradient;\n          const changeHigh = this.changesHigh[layer][node][k] * trainOpts.beta2 + (1 - trainOpts.beta2) * gradient * gradient;\n\n          const momentumCorrection = changeLow / (1 - Math.pow(trainOpts.beta1, this.iterations));\n          const gradientCorrection = changeHigh / (1 - Math.pow(trainOpts.beta2, this.iterations));\n\n          this.changesLow[layer][node][k] = changeLow;\n          this.changesHigh[layer][node][k] = changeHigh;\n          this.weights[layer][node][k] += this.trainOpts.learningRate * momentumCorrection / (Math.sqrt(gradientCorrection) + trainOpts.epsilon);\n        }\n\n        const biasGradient = this.deltas[layer][node];\n        const biasChangeLow = this.biasChangesLow[layer][node] * trainOpts.beta1 + (1 - trainOpts.beta1) * biasGradient;\n        const biasChangeHigh = this.biasChangesHigh[layer][node] * trainOpts.beta2 + (1 - trainOpts.beta2) * biasGradient * biasGradient;\n\n        const biasMomentumCorrection = this.biasChangesLow[layer][node] / (1 - Math.pow(trainOpts.beta1, this.iterations));\n        const biasGradientCorrection = this.biasChangesHigh[layer][node] / (1 - Math.pow(trainOpts.beta2, this.iterations));\n\n        this.biasChangesLow[layer][node] = biasChangeLow;\n        this.biasChangesHigh[layer][node] = biasChangeHigh;\n        this.biases[layer][node] += trainOpts.learningRate * biasMomentumCorrection / (Math.sqrt(biasGradientCorrection) + trainOpts.epsilon);\n      }\n    }\n  }\n\n  /**\n   *\n   * @param data\n   * @returns {*}\n   */\n  formatData(data) {\n    if (!Array.isArray(data)) { // turn stream datum into array\n      data = [data];\n    }\n\n    if (!Array.isArray(data[0].input)) {\n      if (this.inputLookup) {\n        this.inputLookupLength = Object.keys(this.inputLookup).length;\n      } else {\n        const inputLookup = new LookupTable(data, 'input');\n        this.inputLookup = inputLookup.table;\n        this.inputLookupLength = inputLookup.length;\n      }\n    }\n\n    if (!Array.isArray(data[0].output)) {\n      if (this.outputLookup) {\n        this.outputLookupLength = Object.keys(this.outputLookup).length;\n      } else {\n        const lookup = new LookupTable(data, 'output');\n        this.outputLookup = lookup.table;\n        this.outputLookupLength = lookup.length;\n      }\n    }\n\n    if (typeof this._formatInput === 'undefined') {\n      this._formatInput = getTypedArrayFn(data[0].input, this.inputLookup);\n      this._formatOutput = getTypedArrayFn(data[0].output, this.outputLookup);\n    }\n\n    // turn sparse hash input into arrays with 0s as filler\n    if (this._formatInput && this._formatOutput) {\n      const result = [];\n      for (let i = 0; i < data.length; i++) {\n        result.push({\n          input: this._formatInput(data[i].input),\n          output: this._formatOutput(data[i].output),\n        });\n      }\n      return result;\n    } else if (this._formatInput) {\n      const result = [];\n      for (let i = 0; i < data.length; i++) {\n        result.push({\n          input: this._formatInput(data[i].input),\n          output: data[i].output\n        });\n      }\n      return result;\n    } else if (this._formatOutput) {\n      const result = [];\n      for (let i = 0; i < data.length; i++) {\n        result.push({\n          input: data[i].input,\n          output: this._formatOutput(data[i].output)\n        });\n      }\n      return result;\n    }\n    return data;\n  }\n\n  addFormat(data) {\n    this.inputLookup = lookup.addKeys(data.input, this.inputLookup);\n    if (this.inputLookup) {\n      this.inputLookupLength = Object.keys(this.inputLookup).length;\n    }\n    this.outputLookup = lookup.addKeys(data.output, this.outputLookup);\n    if (this.outputLookup) {\n      this.outputLookupLength = Object.keys(this.outputLookup).length;\n    }\n  }\n\n  /**\n   *\n   * @param data\n   * @returns {\n   *  {\n   *    error: number,\n   *    misclasses: Array,\n   *  }\n   * }\n   */\n  test(data) {\n    data = this.formatData(data);\n    // for binary classification problems with one output node\n    const isBinary = data[0].output.length === 1;\n    // for classification problems\n    const misclasses = [];\n    // run each pattern through the trained network and collect\n    // error and misclassification statistics\n    let errorSum = 0;\n\n    if (isBinary) {\n      let falsePos = 0;\n      let falseNeg = 0;\n      let truePos = 0;\n      let trueNeg = 0;\n\n      for (let i = 0; i < data.length; i++) {\n        const output = this.runInput(data[i].input);\n        const target = data[i].output;\n        const actual = output[0] > this.binaryThresh ? 1 : 0;\n        const expected = target[0];\n\n        if (actual !== expected) {\n          const misclass = data[i];\n          misclasses.push({\n            input: misclass.input,\n            output: misclass.output,\n            actual,\n            expected\n          });\n        }\n\n        if (actual === 0 && expected === 0) {\n          trueNeg++;\n        } else if (actual === 1 && expected === 1) {\n          truePos++;\n        } else if (actual === 0 && expected === 1) {\n          falseNeg++;\n        } else if (actual === 1 && expected === 0) {\n          falsePos++;\n        }\n\n        errorSum += mse(output.map((value, i) => {\n          return target[i] - value;\n        }));\n      }\n\n      return {\n        error: errorSum / data.length,\n        misclasses: misclasses,\n        total: data.length,\n        trueNeg: trueNeg,\n        truePos: truePos,\n        falseNeg: falseNeg,\n        falsePos: falsePos,\n        precision: truePos > 0 ? truePos / (truePos + falsePos) : 0,\n        recall: truePos > 0 ? truePos / (truePos + falseNeg) : 0,\n        accuracy: (trueNeg + truePos) / data.length\n      };\n    }\n\n    for (let i = 0; i < data.length; i++) {\n      const output = this.runInput(data[i].input);\n      const target = data[i].output;\n      const actual = output.indexOf(max(output));\n      const expected = target.indexOf(max(target));\n\n      if (actual !== expected) {\n        const misclass = data[i];\n        misclasses.push({\n          input: misclass.input,\n          output: misclass.output,\n          actual,\n          expected\n        });\n      }\n\n      errorSum += mse(output.map((value, i) => {\n        return target[i] - value;\n      }));\n    }\n    return {\n      error: errorSum / data.length,\n      misclasses: misclasses,\n      total: data.length\n    };\n  }\n\n  /**\n   *\n   * @returns\n   *  {\n   *    layers: [\n   *      {\n   *        x: {},\n   *        y: {}\n   *      },\n   *      {\n   *        '0': {\n   *          bias: -0.98771313,\n   *          weights: {\n   *            x: 0.8374838,\n   *            y: 1.245858\n   *          },\n   *        '1': {\n   *          bias: 3.48192004,\n   *          weights: {\n   *            x: 1.7825821,\n   *            y: -2.67899\n   *          }\n   *        }\n   *      },\n   *      {\n   *        f: {\n   *          bias: 0.27205739,\n   *          weights: {\n   *            '0': 1.3161821,\n   *            '1': 2.00436\n   *          }\n   *        }\n   *      }\n   *    ]\n   *  }\n   */\n  toJSON() {\n    const layers = [];\n    for (let layer = 0; layer <= this.outputLayer; layer++) {\n      layers[layer] = {};\n\n      let nodes;\n      // turn any internal arrays back into hashes for readable json\n      if (layer === 0 && this.inputLookup) {\n        nodes = Object.keys(this.inputLookup);\n      } else if (this.outputLookup && layer === this.outputLayer) {\n        nodes = Object.keys(this.outputLookup);\n      } else {\n        nodes = range(0, this.sizes[layer]);\n      }\n\n      for (let j = 0; j < nodes.length; j++) {\n        const node = nodes[j];\n        layers[layer][node] = {};\n\n        if (layer > 0) {\n          layers[layer][node].bias = this.biases[layer][j];\n          layers[layer][node].weights = {};\n          for (let k in layers[layer - 1]) {\n            let index = k;\n            if (layer === 1 && this.inputLookup) {\n              index = this.inputLookup[k];\n            }\n            layers[layer][node].weights[k] = this.weights[layer][j][index];\n          }\n        }\n      }\n    }\n    return {\n      sizes: this.sizes.slice(0),\n      layers,\n      outputLookup: this.outputLookup !== null,\n      inputLookup: this.inputLookup !== null,\n      activation: this.activation,\n      trainOpts: this.getTrainOptsJSON()\n    };\n  }\n\n  /**\n   *\n   * @param json\n   * @returns {NeuralNetwork}\n   */\n  fromJSON(json) {\n    Object.assign(this, this.constructor.defaults, json);\n    this.sizes = json.sizes;\n    this.initialize();\n\n    for (let i = 0; i <= this.outputLayer; i++) {\n      let layer = json.layers[i];\n      if (i === 0 && (!layer[0] || json.inputLookup)) {\n        this.inputLookup = lookup.toHash(layer);\n        this.inputLookupLength = Object.keys(this.inputLookup).length;\n      }\n      else if (i === this.outputLayer && (!layer[0] || json.outputLookup)) {\n        this.outputLookup = lookup.toHash(layer);\n      }\n      if (i > 0) {\n        const nodes = Object.keys(layer);\n        this.sizes[i] = nodes.length;\n        for (let j in nodes) {\n          const node = nodes[j];\n          this.biases[i][j] = layer[node].bias;\n          this.weights[i][j] = toArray(layer[node].weights);\n        }\n      }\n    }\n    if (json.hasOwnProperty('trainOpts')) {\n      this.updateTrainingOptions(json.trainOpts);\n    }\n    return this;\n  }\n\n  /**\n   *\n   * @returns {Function}\n   */\n  toFunction() {\n    const activation = this.activation;\n    const leakyReluAlpha = this.leakyReluAlpha;\n    let needsVar = false;\n    function nodeHandle(layers, layerNumber, nodeKey) {\n      if (layerNumber === 0) {\n        return (typeof nodeKey === 'string'\n          ? `input['${nodeKey}']`\n          : `input[${nodeKey}]`);\n      }\n\n      const layer = layers[layerNumber];\n      const node = layer[nodeKey];\n      let result = ['(' , node.bias];\n      for (let w in node.weights) {\n        if (node.weights[w] < 0) {\n          result.push(`${node.weights[w]}*${nodeHandle(layers, layerNumber - 1, w)}`);\n        } else {\n          result.push(`+${node.weights[w]}*${nodeHandle(layers, layerNumber - 1, w)}`);\n        }\n      }\n      result.push(')');\n\n      switch (activation) {\n        case 'sigmoid':\n          return `1/(1+1/Math.exp(${result.join('')}))`;\n        case 'relu': {\n          needsVar = true;\n          return `((v=${result.join('')})<0?0:v)`;\n        }\n        case 'leaky-relu': {\n          needsVar = true;\n          return `((v=${result.join('')})<0?0:${leakyReluAlpha}*v)`;\n        }\n        case 'tanh':\n          return `Math.tanh(${result.join('')})`;\n        default:\n          throw new Error('unknown activation type ' + activation);\n      }\n    }\n\n    const layers = this.toJSON().layers;\n    const layersAsMath = [];\n    let result;\n    for (let i in layers[layers.length - 1]) {\n      layersAsMath.push(nodeHandle(layers, layers.length - 1, i));\n    }\n    if (this.outputLookup) {\n      result = `{${\n        Object.keys(this.outputLookup)\n          .map((key, i) => `'${key}':${layersAsMath[i]}`)\n        }}`;\n    } else {\n      result = `[${layersAsMath.join(',')}]`;\n    }\n\n    return new Function('input', `${ needsVar ? 'var v;' : '' }return ${result};`);\n  }\n}\n\n\nfunction getTypedArrayFn(value, table) {\n  if (value.buffer instanceof ArrayBuffer) {\n    return null;\n  } else if (Array.isArray(value)) {\n    return arrayToFloat32Array;\n  } else {\n    const length = Object.keys(table).length;\n    return (v) => {\n      const array = new Float32Array(length);\n      for (let p in table) {\n        array[table[p]] = v[p] || 0;\n      }\n      return array;\n    }\n  }\n}\n"]}